# jobs/dotnet-build-test.yml  (drop-in)
parameters:
- name: artifact_name
  type: string
  default: drop
- name: project_dir
  type: string
  default: $(Build.SourcesDirectory)   # repo root or a subfolder

steps:
- task: UseDotNet@2
  inputs:
    packageType: sdk
    version: 8.x
  displayName: Use .NET 8

- task: DotNetCoreCLI@2
  displayName: Restore
  inputs:
    command: 'restore'
    projects: '**/*.sln'            # falls back to all solutions
    workingDirectory: ${{ parameters.project_dir }}

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    command: 'build'
    projects: '**/*.sln'
    arguments: '--configuration Release --no-restore'
    workingDirectory: ${{ parameters.project_dir }}

- task: DotNetCoreCLI@2
  displayName: Test
  inputs:
    command: 'test'
    projects: '**/*Tests/*.csproj'  # adjust to your test project pattern
    arguments: '--configuration Release --no-build --logger trx --results-directory $(Build.SourcesDirectory)/TestResults'
    publishTestResults: true
    workingDirectory: ${{ parameters.project_dir }}

- script: |
    echo "Repo root: $(Build.SourcesDirectory)"
    find "$(Build.SourcesDirectory)" -maxdepth 4 -type f \( -name "*.sln" -o -name "*.csproj" \) -print
  displayName: Locate .NET projects
  workingDirectory: ${{ parameters.project_dir }}

- task: PublishPipelineArtifact@1
  inputs:
    targetPath: '$(Build.SourcesDirectory)/dist'
    artifact: ${{ parameters.artifact_name }}
  displayName: Publish artifact
