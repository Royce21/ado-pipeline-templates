# ado-pipeline-templates/pipelines/multi-stage.yml
# Entry-point template that consumer pipelines extend via:
# extends:
#   template: pipelines/multi-stage.yml@templates

parameters:
- name: app_type
  type: string
  default: dotnet
  values:
    - dotnet
    - node

- name: env
  type: string
  default: dev
  values:
    - dev
    - qa
    - prod

- name: enable_deploy
  type: boolean
  default: false

- name: vmImage
  type: string
  default: ubuntu-latest

- name: artifact_name
  type: string
  default: drop

- name: service_connection
  type: string
  default: ""     # empty â‡’ AzureCLI@2 step omitted

- name: path_filter
  type: object
  default:
    include: []
    exclude: []

- name: var_groups
  type: object
  default: []     # e.g., ['app-qa', 'shared-secrets']

stages:
# ---------------- CI ----------------
- template: ../stages/ci.yml
  parameters:
    app_type:      ${{ parameters.app_type }}
    vmImage:       ${{ parameters.vmImage }}
    artifact_name: ${{ parameters.artifact_name }}
    path_filter:   ${{ parameters.path_filter }}

# ---------------- CD (guarded) ----------------
# Only include the Deploy stage if:
#  - enable_deploy is true AND
#  - the branch is main or release/*
- ${{ if and(eq(parameters.enable_deploy, true),
             or(contains(variables['Build.SourceBranch'], '/main'),
                contains(variables['Build.SourceBranch'], '/release/'))) }}:
  - template: ../stages/cd.yml
    parameters:
      env:                ${{ parameters.env }}
      vmImage:            ${{ parameters.vmImage }}
      artifact_name:      ${{ parameters.artifact_name }}
      service_connection: ${{ parameters.service_connection }}
      var_groups:         ${{ parameters.var_groups }}
